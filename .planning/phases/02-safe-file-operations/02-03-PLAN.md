---
phase: 02-safe-file-operations
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/file-safety/safe-writer.ts
  - src/file-safety/restore-manager.ts
  - src/file-safety/index.ts
  - src/types/backup.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Safe write creates backup before modifying file"
    - "Safe write validates output after atomic write"
    - "Auto-rollback restores from backup on validation failure"
    - "User can list available backups for a target file"
    - "User can restore file from selected backup"
    - "Restore creates backup of current file before overwriting"
  artifacts:
    - path: "src/file-safety/safe-writer.ts"
      provides: "Orchestrated safe file write with backup and rollback"
      exports: ["safeWrite"]
    - path: "src/file-safety/restore-manager.ts"
      provides: "Backup discovery and restore functionality"
      exports: ["discoverBackups", "restoreFromBackup"]
    - path: "src/types/backup.ts"
      provides: "Backup-related type definitions"
      exports: ["BackupInfo", "SafeWriteOptions", "SafeWriteResult"]
  key_links:
    - from: "src/file-safety/safe-writer.ts"
      to: "src/file-safety/backup-manager.ts"
      via: "createBackup before write"
      pattern: "import.*createBackup.*from.*backup-manager"
    - from: "src/file-safety/safe-writer.ts"
      to: "src/file-safety/atomic-writer.ts"
      via: "atomicWrite for file modification"
      pattern: "import.*atomicWrite.*from.*atomic-writer"
    - from: "src/file-safety/safe-writer.ts"
      to: "src/file-safety/markdown-validator.ts"
      via: "validateMarkdownStructure after write"
      pattern: "import.*validateMarkdownStructure.*from.*markdown-validator"
    - from: "src/file-safety/restore-manager.ts"
      to: "src/file-safety/atomic-writer.ts"
      via: "atomicWrite for restore operation"
      pattern: "import.*atomicWrite.*from.*atomic-writer"
---

<objective>
Create safe write orchestrator that combines backup, atomic write, and auto-rollback, plus restore functionality for user recovery.

Purpose: This is the main API for file modifications - ensuring every write is protected by backup, validated after completion, and automatically rolled back if validation fails. Restore provides user-initiated recovery.

Output: safeWrite function orchestrating the full safety flow, plus discoverBackups and restoreFromBackup for user recovery.
</objective>

<execution_context>
@/Users/antonin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/antonin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-safe-file-operations/02-CONTEXT.md
@.planning/phases/02-safe-file-operations/02-RESEARCH.md
@.planning/phases/02-safe-file-operations/02-01-SUMMARY.md
@.planning/phases/02-safe-file-operations/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create safe writer orchestrating backup, write, and rollback</name>
  <files>
src/types/backup.ts
src/file-safety/safe-writer.ts
  </files>
  <action>
Create src/types/backup.ts:

1. BackupInfo interface (for backup discovery):
   - filename: string
   - path: string (absolute)
   - timestamp: Date
   - hash: string
   - size: number

2. SafeWriteOptions interface:
   - backupDir: string (where to store backups)
   - validate?: boolean (default true - run markdown validation)

3. SafeWriteResult interface:
   - success: boolean
   - targetPath: string
   - backupPath: string
   - rolledBack: boolean (true if validation failed and restore happened)

Create src/file-safety/safe-writer.ts:

1. safeWrite(targetPath: string, content: string, options: SafeWriteOptions): Promise&lt;SafeWriteResult&gt;

Flow:
a. Create backup using createBackup(targetPath, options.backupDir)
   - If backup fails: throw immediately (SAFETY-04: halt if backup fails)
   - Error: "Cannot proceed without backup: {error.message}"

b. Perform atomic write using atomicWrite(targetPath, content)
   - If write fails: throw with error (backup exists for manual recovery)
   - Error includes backup location: "Write failed. Backup available at: {backupPath}"

c. If options.validate (default true):
   - Read written file content
   - Call validateMarkdownStructure
   - If validation fails:
     - Log: "Validation failed, restoring from backup"
     - Read backup content
     - Call atomicWrite to restore original content
     - Return { success: false, targetPath, backupPath, rolledBack: true }
     - If restore fails: throw critical error with both file locations

d. Return { success: true, targetPath, backupPath, rolledBack: false }

Import from:
- ./backup-manager.js: createBackup
- ./atomic-writer.js: atomicWrite
- ./markdown-validator.js: validateMarkdownStructure
- fs/promises: readFile
  </action>
  <verify>
npm run build succeeds.
Test safeWrite flow:
1. Write valid content - succeeds, backup exists
2. Write invalid content (empty) - auto-rollback, original content restored
3. Test with backup failure (mock or read-only backup dir) - operation halts
  </verify>
  <done>
safeWrite orchestrates backup -> write -> validate -> auto-rollback.
Backup created before any modification attempt.
Validation failure triggers automatic restore from backup.
Error messages include backup path for manual recovery.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create restore manager with backup discovery and restoration</name>
  <files>
src/file-safety/restore-manager.ts
src/file-safety/index.ts
src/types/index.ts
  </files>
  <action>
Create src/file-safety/restore-manager.ts:

1. discoverBackups(backupDir: string, targetFilename: string): Promise&lt;BackupInfo[]&gt;
   - Read backup directory contents
   - Filter to backups matching target file (starts with baseName)
   - Parse filename to extract timestamp and hash
   - Filename pattern: {baseName}_{timestamp}_{hash}.md
   - Get file size from fs.promises.stat
   - Return array sorted by timestamp descending (newest first)
   - Return empty array if backup directory doesn't exist (not an error)

2. restoreFromBackup(backupPath: string, targetPath: string, backupDir: string): Promise&lt;void&gt;
   - First: create backup of CURRENT file before restore (per research recommendation)
     - Use special prefix: {baseName}_pre-restore_{timestamp}_{hash}.md
     - This prevents accidental loss if user restores wrong version
   - Read backup content
   - Use atomicWrite to write backup content to targetPath
   - On failure: throw with clear error, original file unchanged

Import BackupInfo from types/backup.ts.
Import atomicWrite from atomic-writer.ts.
Import generateContentHash from hash-generator.ts.

Update src/file-safety/index.ts:
- Export safeWrite and SafeWriteResult, SafeWriteOptions
- Export discoverBackups, restoreFromBackup
- Export BackupInfo type

Update src/types/index.ts:
- Export all from backup.ts
  </action>
  <verify>
npm run build succeeds.
Test restore flow:
1. Create multiple backups with different timestamps
2. discoverBackups returns them sorted newest-first
3. restoreFromBackup replaces target with backup content
4. Verify pre-restore backup created before restoration
  </verify>
  <done>
discoverBackups lists available backups sorted by recency.
restoreFromBackup safely restores file with pre-restore backup.
All types and functions exported through module indices.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. npm run build compiles without errors
2. Full safeWrite flow works: backup -> write -> validate
3. Invalid content triggers auto-rollback
4. Backups discoverable and restorable
5. All exports available from src/file-safety/index.ts
</verification>

<success_criteria>
- safeWrite creates backup before any modification
- Validation failure triggers automatic rollback
- User can list and restore from backups
- Restore creates pre-restore backup (safety net)
- All file-safety functions accessible through module index
- Complete coverage of SAFETY-01 through SAFETY-07 requirements
</success_criteria>

<output>
After completion, create `.planning/phases/02-safe-file-operations/02-03-SUMMARY.md`
</output>

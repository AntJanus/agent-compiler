---
phase: 04-cli-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/cli.ts
  - src/cli/help.ts
  - src/cli/version.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can run `npx agent-compiler --help` and see usage documentation"
    - "User can run `npx agent-compiler --version` and see version number"
    - "User can run `npx agent-compiler compile` and CLI starts without errors"
    - "CLI uses proper exit codes (0 for success, 1 for errors)"
  artifacts:
    - path: "src/cli/cli.ts"
      provides: "CLI entry point with shebang and argument parsing"
      contains: "#!/usr/bin/env node"
    - path: "src/cli/help.ts"
      provides: "Help text generation"
      exports: ["showHelp"]
    - path: "src/cli/version.ts"
      provides: "Version display from package.json"
      exports: ["showVersion"]
    - path: "package.json"
      provides: "bin entry pointing to dist/cli/cli.js"
      contains: "agent-compiler"
  key_links:
    - from: "src/cli/cli.ts"
      to: "util.parseArgs"
      via: "Node.js built-in argument parsing"
      pattern: "parseArgs.*options"
    - from: "src/cli/version.ts"
      to: "package.json"
      via: "fs.readFile to get version"
      pattern: "readFile.*package\\.json"
---

<objective>
Create CLI entry point with argument parsing, help documentation, and version display

Purpose: Users need to invoke the tool via `npx agent-compiler` with standard CLI flags (--help, --version). This establishes the foundation for the interactive compile command.

Output: Executable CLI entry point at src/cli/cli.ts with help and version commands working.
</objective>

<execution_context>
@/Users/antonin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/antonin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cli-polish/04-RESEARCH.md

# Prior phase context
@.planning/phases/03-core-embedding/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI entry point with argument parsing</name>
  <files>
    src/cli/cli.ts
    package.json
  </files>
  <action>
Create src/cli/cli.ts as the main CLI entry point:

1. Add shebang: `#!/usr/bin/env node`
2. Import `parseArgs` from `node:util` (built-in, no install needed)
3. Parse arguments with options:
   - `version`: { type: 'boolean', short: 'v' }
   - `help`: { type: 'boolean', short: 'h' }
   - `dry-run`: { type: 'boolean' }
4. Allow positional arguments (the command, e.g., "compile")
5. Handle --version by calling showVersion() and setting process.exitCode = 0
6. Handle --help by calling showHelp() and setting process.exitCode = 0
7. If positional[0] === 'compile', call runCompile(options) (stub for now - console.log placeholder)
8. If no command or unknown command, show help and set process.exitCode = 1
9. Wrap main logic in async main() function with try/catch
10. On error, console.error the message and set process.exitCode = 1 (NOT process.exit())

Update package.json:
1. Change `bin` entry from `"agent-compiler": "dist/cli.js"` to `"agent-compiler": "dist/cli/cli.js"`
2. Add new dependencies:
   - `@clack/prompts` (for Task 2 in next plan)
   - `picocolors` (for colored output)
   - `ora` (for spinners)

Why these patterns:
- Use process.exitCode not process.exit() to avoid truncating stdout
- Use util.parseArgs not commander (101KB saved, sufficient for simple flags)
- Shebang `/usr/bin/env node` not hardcoded path for cross-platform
  </action>
  <verify>
1. `npm run build` succeeds
2. `node dist/cli/cli.js --version` outputs version
3. `node dist/cli/cli.js --help` outputs help text
4. `node dist/cli/cli.js compile` outputs placeholder message
5. `node dist/cli/cli.js unknown` shows help and exits with code 1
  </verify>
  <done>
CLI entry point parses --help, --version, --dry-run flags using util.parseArgs. Package.json updated with correct bin path and new dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement help and version display</name>
  <files>
    src/cli/help.ts
    src/cli/version.ts
  </files>
  <action>
Create src/cli/help.ts:
1. Import picocolors as `pc`
2. Export function showHelp(): void
3. Generate formatted help text with sections:
   - Header: agent-compiler - Embed Claude skills and commands into CLAUDE.md
   - USAGE section with examples:
     - `npx agent-compiler compile` - Run interactive wizard
     - `npx agent-compiler compile --dry-run` - Preview changes
     - `npx agent-compiler --version` - Show version
     - `npx agent-compiler --help` - Show help
   - OPTIONS section:
     - `--dry-run` - Preview changes without writing files
     - `-h, --help` - Show help message
     - `-v, --version` - Show version number
   - EXAMPLES section with practical examples
   - DOCUMENTATION link placeholder
4. Use pc.bold() for section headers, pc.cyan() for commands, pc.dim() for examples

Create src/cli/version.ts:
1. Import `readFile` from `node:fs/promises`
2. Import `fileURLToPath` from `node:url`
3. Import `join` from `node:path`
4. Export async function showVersion(): Promise<void>
5. Compute package.json path using import.meta.url (ESM pattern):
   ```
   const __dirname = fileURLToPath(new URL('.', import.meta.url));
   const pkgPath = join(__dirname, '../../package.json');
   ```
6. Read and parse package.json
7. console.log version in format `v${pkg.version}`

Why ESM pattern for __dirname:
- ES modules don't have __dirname global
- Must derive from import.meta.url
- Path goes up two levels: cli/ -> src/ -> package.json
  </action>
  <verify>
1. `npm run build` succeeds
2. `node dist/cli/cli.js --version` outputs `v0.1.0`
3. `node dist/cli/cli.js --help` outputs formatted help with colors (if terminal supports)
4. Help text includes all documented flags and usage examples
  </verify>
  <done>
Help displays formatted usage documentation with color coding. Version reads from package.json and displays current version.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build and run CLI:
```bash
npm run build
node dist/cli/cli.js --version
node dist/cli/cli.js --help
node dist/cli/cli.js compile
node dist/cli/cli.js
```

2. Verify exit codes:
```bash
node dist/cli/cli.js --help; echo "Exit code: $?"  # Should be 0
node dist/cli/cli.js unknown; echo "Exit code: $?"  # Should be 1
```

3. Verify dependencies installed:
```bash
npm ls @clack/prompts picocolors ora
```
</verification>

<success_criteria>
- CLI invokable as `npx agent-compiler` with --help, --version flags working
- Help text formatted with colors when terminal supports it
- Version displays current package.json version
- Exit codes: 0 for success, 1 for errors
- No use of process.exit() - uses process.exitCode instead
- Dependencies @clack/prompts, picocolors, ora installed
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-polish/04-01-SUMMARY.md`
</output>

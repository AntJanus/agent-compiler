---
phase: 04-cli-polish
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/cli/commands/compile.ts
  - src/cli/cli.ts
autonomous: false

must_haves:
  truths:
    - "User can run full compile wizard: select target, select content, select skills/commands"
    - "User sees progress spinner during discovery and embedding operations"
    - "Dry-run mode shows what would be embedded without writing files"
    - "Errors display with actionable resolution steps"
    - "Successful compile shows summary of what was embedded"
  artifacts:
    - path: "src/cli/commands/compile.ts"
      provides: "Main compile command orchestrating full flow"
      exports: ["runCompile"]
  key_links:
    - from: "src/cli/commands/compile.ts"
      to: "src/discovery/index.ts"
      via: "discoverAll"
      pattern: "discoverAll|discoverSkills"
    - from: "src/cli/commands/compile.ts"
      to: "src/embedding/index.ts"
      via: "mergeEmbeddedContent"
      pattern: "mergeEmbeddedContent"
    - from: "src/cli/commands/compile.ts"
      to: "src/cli/prompts/index.ts"
      via: "interactive selection"
      pattern: "selectSkills|selectCommands|selectTargetFile"
---

<objective>
Implement the main compile command that orchestrates the full interactive flow with dry-run support

Purpose: This is the core user-facing feature - the interactive wizard that discovers skills/commands, lets users select what to embed, and performs the embedding with proper feedback.

Output: Complete compile command that ties together discovery, selection, and embedding with progress feedback.
</objective>

<execution_context>
@/Users/antonin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/antonin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cli-polish/04-RESEARCH.md

# Integration points
@src/discovery/index.ts
@src/embedding/index.ts
@src/parser/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement compile command with full interactive flow</name>
  <files>
    src/cli/commands/compile.ts
  </files>
  <action>
Create src/cli/commands/compile.ts:

1. Imports:
   ```typescript
   import { intro, outro, log, spinner } from '@clack/prompts';
   import pc from 'picocolors';
   import { discoverAll } from '../../discovery/index.js';
   import { parseSkill } from '../../parser/index.js';
   import { mergeEmbeddedContent } from '../../embedding/index.js';
   import { selectTargetFile, selectContentTypes, selectSkills, selectCommands } from '../prompts/index.js';
   import { withSpinner, ActionableError } from '../output/index.js';
   import { detectLineEnding, normalizeLineEnding } from '../../file-safety/index.js';
   import type { ParsedSkill, ParsedCommand, Skill, Command } from '../../types/index.js';
   ```

2. Export interface CompileOptions:
   ```typescript
   export interface CompileOptions {
     dryRun?: boolean;
     cwd?: string;
   }
   ```

3. Export async function runCompile(options: CompileOptions = {}): Promise<void>

4. Implementation flow:
   a. Show intro banner: `intro(pc.bgCyan(pc.black(' agent-compiler ')))`

   b. Discover skills and commands with spinner:
      ```typescript
      const discovery = await withSpinner('Discovering skills and commands...', async () => {
        const result = await discoverAll({ cwd: options.cwd });
        return result;
      });
      ```

   c. Check if anything was found:
      - If no skills and no commands: log.warn('No skills or commands found'), outro, return

   d. Parse discovered skills:
      ```typescript
      const parsedSkills = await withSpinner('Parsing skills...', async () => {
        const parsed: ParsedSkill[] = [];
        for (const skillPath of discovery.skills) {
          const skill = await parseSkill(skillPath);
          parsed.push(skill);
        }
        return parsed;
      });
      ```

   e. Parse discovered commands (similar pattern)

   f. Prompt for target file:
      ```typescript
      const target = await selectTargetFile(options.cwd);
      if (!target) {
        outro(pc.yellow('Cancelled'));
        return;
      }
      ```

   g. Prompt for content types:
      ```typescript
      const contentTypes = await selectContentTypes();
      if (!contentTypes) {
        outro(pc.yellow('Cancelled'));
        return;
      }
      ```

   h. If contentTypes includes 'skills' and parsedSkills.length > 0:
      - Prompt skill selection
      - Handle cancellation

   i. If contentTypes includes 'commands' and parsedCommands.length > 0:
      - Prompt command selection
      - Handle cancellation

   j. Convert ParsedSkill[] to Skill[] for embedding:
      ```typescript
      const skillsToEmbed: Skill[] = selectedSkills.map(ps => ({
        name: ps.metadata.name,
        description: ps.metadata.description,
        location: ps.location,
        content: ps.content
      }));
      ```

   k. Handle dry-run mode:
      ```typescript
      if (options.dryRun) {
        log.info(pc.yellow('Dry run mode - no files will be modified'));
        log.info(`Target: ${target.path}`);
        log.info(`Skills: ${skillsToEmbed.length}`);
        log.info(`Commands: ${commandsToEmbed.length}`);
        // Show what would be embedded
        for (const skill of skillsToEmbed) {
          log.info(`  - ${skill.name} (${skill.location})`);
        }
        outro(pc.yellow('Dry run complete - no changes made'));
        return;
      }
      ```

   l. Perform embedding with spinner:
      ```typescript
      const result = await withSpinner('Embedding content...', async () => {
        return await mergeEmbeddedContent({
          targetPath: target.path,
          skills: skillsToEmbed,
          commands: commandsToEmbed
        });
      });
      ```

   m. Show success summary:
      ```typescript
      if (result.skipped) {
        log.info('Content unchanged - skipped write');
      } else {
        log.success(`Embedded ${skillsToEmbed.length} skills and ${commandsToEmbed.length} commands`);
        if (result.backupPath) {
          log.info(`Backup created: ${result.backupPath}`);
        }
      }
      outro(pc.green('Done!'));
      ```

5. Wrap entire function body in try/catch:
   - If ActionableError, console.error(error.format())
   - Otherwise, console.error(pc.red(error.message))
   - Set process.exitCode = 1
  </action>
  <verify>
1. `npm run build` succeeds
2. Create test skills directory with sample skill
3. Run `node dist/cli/cli.js compile --dry-run` and verify:
   - Discovery finds skills
   - Prompts work correctly
   - Dry run shows summary without writing
4. Run `node dist/cli/cli.js compile` and verify actual embedding works
  </verify>
  <done>
Compile command provides full interactive wizard with discovery, selection, dry-run preview, and actual embedding with progress feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire compile command into CLI entry point</name>
  <files>
    src/cli/cli.ts
  </files>
  <action>
Update src/cli/cli.ts:

1. Replace placeholder compile stub with actual import:
   ```typescript
   import { runCompile } from './commands/compile.js';
   ```

2. Update the compile command handler:
   ```typescript
   if (positionals[0] === 'compile') {
     await runCompile({
       dryRun: values['dry-run'],
       cwd: process.cwd()
     });
     return;
   }
   ```

3. Ensure proper error handling wraps the entire main function

4. Add handling for no command (show help):
   ```typescript
   if (positionals.length === 0) {
     showHelp();
     return;
   }
   ```

5. Add handling for unknown command:
   ```typescript
   console.error(pc.red(`Unknown command: ${positionals[0]}`));
   console.error('');
   showHelp();
   process.exitCode = 1;
   ```
  </action>
  <verify>
1. `npm run build` succeeds
2. `node dist/cli/cli.js compile` runs full wizard
3. `node dist/cli/cli.js compile --dry-run` runs in dry-run mode
4. `node dist/cli/cli.js` shows help
5. `node dist/cli/cli.js unknown` shows error and help, exits 1
  </verify>
  <done>
CLI entry point correctly routes to compile command with options. Unknown commands show error. No command shows help.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete CLI tool with interactive compile wizard</what-built>
  <how-to-verify>
1. Build the project: `npm run build`

2. Test help and version:
   ```bash
   node dist/cli/cli.js --help
   node dist/cli/cli.js --version
   ```

3. Create a test skill:
   ```bash
   mkdir -p .claude/skills/test-skill
   cat > .claude/skills/test-skill/SKILL.md << 'EOF'
   ---
   name: Test Skill
   description: A test skill for verification
   ---

   # Test Skill Instructions

   This is a test skill that does test things.
   EOF
   ```

4. Run compile in dry-run mode:
   ```bash
   node dist/cli/cli.js compile --dry-run
   ```
   Expected: Shows discovery, prompts for selections, shows summary without writing

5. Run actual compile:
   ```bash
   node dist/cli/cli.js compile
   ```
   Expected: Creates/updates CLAUDE.md with embedded skill

6. Verify CLAUDE.md has correct structure:
   - User content section (if existed)
   - ## SKILLS section with ### Test Skill
   - Proper markdown formatting

7. Run compile again to test idempotency:
   ```bash
   node dist/cli/cli.js compile
   ```
   Expected: Shows "skipped" if nothing changed

8. Test Ctrl+C during prompts - should exit gracefully
  </how-to-verify>
  <resume-signal>Type "approved" if CLI works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:

1. Full CLI test:
```bash
npm run build
node dist/cli/cli.js --help
node dist/cli/cli.js --version
node dist/cli/cli.js compile --dry-run
node dist/cli/cli.js compile
```

2. Verify exit codes:
```bash
node dist/cli/cli.js --help; echo "Exit: $?"  # 0
node dist/cli/cli.js compile; echo "Exit: $?"  # 0 on success
node dist/cli/cli.js bad; echo "Exit: $?"  # 1
```

3. Check generated CLAUDE.md structure
4. Test idempotency by running compile twice
</verification>

<success_criteria>
- `npx agent-compiler compile` runs full interactive wizard
- Discovery shows spinner during operation
- Skill selection shows global (blue) vs project (green) visual differentiation
- Dry-run mode previews changes without writing
- Actual compile creates/updates target file with embedded content
- Success shows summary of what was embedded
- Errors show actionable resolution steps
- Ctrl+C exits gracefully at any point
- Exit codes: 0 for success, 1 for errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-polish/04-04-SUMMARY.md`
</output>

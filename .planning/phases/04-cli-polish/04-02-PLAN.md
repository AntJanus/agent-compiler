---
phase: 04-cli-polish
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/cli/prompts/target-selection.ts
  - src/cli/prompts/content-selection.ts
  - src/cli/prompts/skill-selection.ts
  - src/cli/prompts/command-selection.ts
  - src/cli/prompts/index.ts
autonomous: true

must_haves:
  truths:
    - "User is prompted to select or create target file (CLAUDE.md or AGENTS.md)"
    - "User sees global skills marked differently from project skills in selection UI"
    - "User can select multiple skills with checkbox-style multiselect"
    - "User can select multiple commands with checkbox-style multiselect"
    - "Cancellation (Ctrl+C) exits gracefully without error"
  artifacts:
    - path: "src/cli/prompts/target-selection.ts"
      provides: "Target file selection prompt"
      exports: ["selectTargetFile"]
    - path: "src/cli/prompts/content-selection.ts"
      provides: "Content type selection (skills, commands, or both)"
      exports: ["selectContentTypes"]
    - path: "src/cli/prompts/skill-selection.ts"
      provides: "Skill multiselect with global/project visual differentiation"
      exports: ["selectSkills"]
    - path: "src/cli/prompts/command-selection.ts"
      provides: "Command multiselect prompt"
      exports: ["selectCommands"]
    - path: "src/cli/prompts/index.ts"
      provides: "Unified prompt exports"
  key_links:
    - from: "src/cli/prompts/skill-selection.ts"
      to: "@clack/prompts"
      via: "multiselect component"
      pattern: "multiselect.*options"
    - from: "src/cli/prompts/skill-selection.ts"
      to: "picocolors"
      via: "global/project visual markers"
      pattern: "pc\\.blue.*global|pc\\.green.*project"
---

<objective>
Create interactive prompt flows for target file selection, content type selection, and skill/command selection with visual differentiation

Purpose: Users need an interactive wizard experience to select which skills and commands to embed. Global vs project skills must be visually distinguished so users can make informed selections.

Output: Complete prompt modules that guide users through the compilation wizard.
</objective>

<execution_context>
@/Users/antonin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/antonin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cli-polish/04-RESEARCH.md

# Prior phase for types
@src/types/skill.ts
@src/types/command.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create target file and content type selection prompts</name>
  <files>
    src/cli/prompts/target-selection.ts
    src/cli/prompts/content-selection.ts
  </files>
  <action>
Create src/cli/prompts/target-selection.ts:
1. Import `select`, `text`, `isCancel` from '@clack/prompts'
2. Import `pc` from 'picocolors'
3. Import `existsSync` from 'node:fs'
4. Import `resolve` from 'node:path'

5. Export interface TargetFileResult:
   - path: string
   - isNew: boolean

6. Export async function selectTargetFile(cwd: string = process.cwd()): Promise<TargetFileResult | null>
7. Check if CLAUDE.md or AGENTS.md exists in cwd
8. Build options based on what exists:
   - If CLAUDE.md exists: "Use existing CLAUDE.md" option
   - If AGENTS.md exists: "Use existing AGENTS.md" option
   - Always: "Create new CLAUDE.md" option
   - Always: "Create new AGENTS.md" option
9. Use select() prompt with message "Select target file:"
10. Handle cancellation: if (isCancel(result)) return null
11. Return { path: resolved_path, isNew: boolean }

Create src/cli/prompts/content-selection.ts:
1. Import `multiselect`, `isCancel` from '@clack/prompts'
2. Export type ContentType = 'skills' | 'commands'
3. Export async function selectContentTypes(): Promise<ContentType[] | null>
4. Use multiselect() with options:
   - { value: 'skills', label: 'Skills', hint: 'Embed selected skills' }
   - { value: 'commands', label: 'Commands', hint: 'Embed selected commands' }
5. Set required: true (must select at least one)
6. Handle cancellation: if (isCancel(result)) return null
7. Return result as ContentType[]

Why isCancel pattern:
- @clack/prompts returns a symbol on Ctrl+C
- Must check with isCancel() not typeof === 'symbol'
- Return null to signal cancellation to caller
  </action>
  <verify>
1. `npm run build` succeeds
2. Manual test: import and call selectTargetFile() - shows options based on existing files
3. Manual test: Ctrl+C during prompt returns null (no crash)
4. Manual test: selectContentTypes() allows multiple selection
  </verify>
  <done>
Target file prompt detects existing CLAUDE.md/AGENTS.md and offers appropriate options. Content type prompt allows multiselect of skills and/or commands. Both handle cancellation gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create skill and command selection prompts with visual differentiation</name>
  <files>
    src/cli/prompts/skill-selection.ts
    src/cli/prompts/command-selection.ts
    src/cli/prompts/index.ts
  </files>
  <action>
Create src/cli/prompts/skill-selection.ts:
1. Import `multiselect`, `isCancel` from '@clack/prompts'
2. Import `pc` from 'picocolors'
3. Import type { ParsedSkill } from '../../types/index.js'

4. Export async function selectSkills(skills: ParsedSkill[]): Promise<ParsedSkill[] | null>
5. If no skills available, return empty array (nothing to select)
6. Build options array from skills:
   - For each skill, create option:
     ```typescript
     {
       value: skill,  // Store the full ParsedSkill object
       label: skill.location === 'global'
         ? `${pc.blue('(global)')} ${skill.metadata.name}`
         : `${pc.green('(project)')} ${skill.metadata.name}`,
       hint: skill.metadata.description || undefined
     }
     ```
7. Group options: global skills first, then project skills (sort by location)
8. Use multiselect() with message "Select skills to embed:"
9. Set required: false (user might only want commands)
10. Handle cancellation: if (isCancel(result)) return null
11. Return result as ParsedSkill[]

Create src/cli/prompts/command-selection.ts:
1. Import `multiselect`, `isCancel` from '@clack/prompts'
2. Import `pc` from 'picocolors'
3. Import type { ParsedCommand } from '../../types/index.js'

4. Export async function selectCommands(commands: ParsedCommand[]): Promise<ParsedCommand[] | null>
5. If no commands available, return empty array
6. Build options from commands:
   ```typescript
   {
     value: command,
     label: command.name,
     hint: command.description || undefined
   }
   ```
7. Use multiselect() with message "Select commands to embed:"
8. Set required: false
9. Handle cancellation: if (isCancel(result)) return null
10. Return result as ParsedCommand[]

Create src/cli/prompts/index.ts:
1. Export all from target-selection.js
2. Export all from content-selection.js
3. Export all from skill-selection.js
4. Export all from command-selection.js

Why value: skill (full object):
- @clack/prompts returns the value directly
- Storing full ParsedSkill means we get back the exact objects needed for embedding
- No need to match by path later
  </action>
  <verify>
1. `npm run build` succeeds
2. Manual test: selectSkills() shows global skills with blue (global) prefix
3. Manual test: selectSkills() shows project skills with green (project) prefix
4. Manual test: Empty skills array returns [] without showing prompt
5. Manual test: Selected skills are returned as full ParsedSkill objects
  </verify>
  <done>
Skill selection UI visually differentiates global (blue) from project (green) skills. Command selection provides clean multiselect. Both return full parsed objects ready for embedding.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build and verify no TypeScript errors:
```bash
npm run build
```

2. Create a test script to verify prompt behavior:
```typescript
// test-prompts.ts (temporary, don't commit)
import { selectTargetFile, selectContentTypes, selectSkills, selectCommands } from './dist/cli/prompts/index.js';

const target = await selectTargetFile();
console.log('Target:', target);

const types = await selectContentTypes();
console.log('Types:', types);
```

3. Verify visual differentiation appears correctly in terminal
4. Test Ctrl+C handling returns null without crash
</verification>

<success_criteria>
- Target selection shows existing CLAUDE.md/AGENTS.md if present
- Content type selection allows multiselect of skills/commands
- Skill selection shows (global) in blue and (project) in green
- Command selection provides clean multiselect interface
- All prompts handle Ctrl+C gracefully (return null, no crash)
- Selected items return as full parsed objects (not just paths)
- Empty input arrays skip prompt and return empty array
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-polish/04-02-SUMMARY.md`
</output>

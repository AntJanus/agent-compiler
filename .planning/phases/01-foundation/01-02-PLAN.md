---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/discovery/skill-discovery.ts
  - src/discovery/command-discovery.ts
  - src/discovery/index.ts
autonomous: true

must_haves:
  truths:
    - "Tool discovers skills from ~/.claude/skills/"
    - "Tool discovers skills from ./.claude/skills/"
    - "Tool discovers commands from ./.claude/commands/"
    - "Missing directories are handled without errors"
    - "Discovered files include location labels (global/project)"
  artifacts:
    - path: "src/discovery/skill-discovery.ts"
      provides: "Skill file discovery from global and project locations"
      exports: ["discoverSkills"]
    - path: "src/discovery/command-discovery.ts"
      provides: "Command file discovery"
      exports: ["discoverCommands"]
    - path: "src/discovery/index.ts"
      provides: "Discovery module exports"
      exports: ["discoverSkills", "discoverCommands", "discoverAll"]
  key_links:
    - from: "src/discovery/skill-discovery.ts"
      to: "fast-glob"
      via: "fg() call with suppressErrors"
      pattern: "fg\\("
    - from: "src/discovery/skill-discovery.ts"
      to: "src/utils/path-resolver.ts"
      via: "import getGlobalSkillsDir, getProjectSkillsDir"
      pattern: "getGlobalSkillsDir|getProjectSkillsDir"
---

<objective>
Implement file discovery for skills and commands from their respective filesystem locations.

Purpose: Enable the tool to find all available skills (global and project) and commands that can be embedded.
Output: Discovery functions that return typed arrays of discovered files with location metadata.
</objective>

<execution_context>
@/Users/antonin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/antonin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement skill discovery from global and project locations</name>
  <files>src/discovery/skill-discovery.ts</files>
  <action>
    Create src/discovery/skill-discovery.ts that discovers SKILL.md files from both locations:

    ```typescript
    import fg from 'fast-glob';
    import { getGlobalSkillsDir, getProjectSkillsDir } from '../utils/path-resolver.js';
    import type { DiscoveredFile, DiscoveryLocation } from '../types/index.js';

    interface DiscoveryOptions {
      cwd?: string;
      includeGlobal?: boolean;
      includeProject?: boolean;
    }

    /**
     * Discover skill SKILL.md files from global and project locations.
     * Silently skips missing directories.
     * Follows symlinks.
     */
    export async function discoverSkills(options: DiscoveryOptions = {}): Promise<DiscoveredFile[]> {
      const {
        cwd = process.cwd(),
        includeGlobal = true,
        includeProject = true
      } = options;

      const results: DiscoveredFile[] = [];

      // Discover from global ~/.claude/skills/
      if (includeGlobal) {
        const globalDir = getGlobalSkillsDir();
        const globalPaths = await fg('*/SKILL.md', {
          cwd: globalDir,
          absolute: true,
          followSymbolicLinks: true,
          onlyFiles: true,
          suppressErrors: true  // Silently skip if directory doesn't exist
        }).catch(() => []);

        results.push(...globalPaths.map(path => ({
          path,
          location: 'global' as DiscoveryLocation
        })));
      }

      // Discover from project ./.claude/skills/
      if (includeProject) {
        const projectDir = getProjectSkillsDir(cwd);
        const projectPaths = await fg('*/SKILL.md', {
          cwd: projectDir,
          absolute: true,
          followSymbolicLinks: true,
          onlyFiles: true,
          suppressErrors: true
        }).catch(() => []);

        results.push(...projectPaths.map(path => ({
          path,
          location: 'project' as DiscoveryLocation
        })));
      }

      return results;
    }
    ```

    Key implementation points:
    - Use fast-glob with suppressErrors: true to handle missing directories
    - followSymbolicLinks: true to support symlinked skills
    - Return absolute paths for reliability
    - Tag each result with location ('global' | 'project')
  </action>
  <verify>
    - `npm run build` compiles without errors
    - Create test directories and verify discovery works:
      ```bash
      mkdir -p /tmp/test-project/.claude/skills/test-skill
      echo -e "---\nname: test\n---\nTest content" > /tmp/test-project/.claude/skills/test-skill/SKILL.md
      ```
    - Run discovery and verify it finds the test skill
  </verify>
  <done>
    Skill discovery finds SKILL.md files from both global and project locations, returns with location labels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement command discovery</name>
  <files>src/discovery/command-discovery.ts</files>
  <action>
    Create src/discovery/command-discovery.ts that discovers command markdown files:

    ```typescript
    import fg from 'fast-glob';
    import { getCommandsDir } from '../utils/path-resolver.js';
    import type { DiscoveredFile } from '../types/index.js';

    interface CommandDiscoveryOptions {
      cwd?: string;
    }

    /**
     * Discover command markdown files from .claude/commands/.
     * Commands are project-only (no global commands directory).
     * Silently skips if directory doesn't exist.
     */
    export async function discoverCommands(options: CommandDiscoveryOptions = {}): Promise<DiscoveredFile[]> {
      const { cwd = process.cwd() } = options;
      const commandsDir = getCommandsDir(cwd);

      const commandPaths = await fg('*.md', {
        cwd: commandsDir,
        absolute: true,
        followSymbolicLinks: true,
        onlyFiles: true,
        suppressErrors: true
      }).catch(() => []);

      // Commands are always project-local
      return commandPaths.map(path => ({
        path,
        location: 'project' as const
      }));
    }
    ```

    Key points:
    - Commands only exist in project .claude/commands/ (no global location)
    - Pattern is *.md (flat, not nested like skills)
    - Same error handling as skills (suppressErrors, catch fallback)
  </action>
  <verify>
    - `npm run build` compiles without errors
    - Test with:
      ```bash
      mkdir -p /tmp/test-project/.claude/commands
      echo "# Test command" > /tmp/test-project/.claude/commands/test.md
      ```
  </verify>
  <done>
    Command discovery finds markdown files from ./.claude/commands/.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create discovery module index with combined discovery function</name>
  <files>src/discovery/index.ts</files>
  <action>
    Create src/discovery/index.ts that exports all discovery functions and adds a combined discoverer:

    ```typescript
    export { discoverSkills } from './skill-discovery.js';
    export { discoverCommands } from './command-discovery.js';

    import { discoverSkills } from './skill-discovery.js';
    import { discoverCommands } from './command-discovery.js';
    import type { DiscoveryResult } from '../types/index.js';

    interface DiscoverAllOptions {
      cwd?: string;
      includeGlobalSkills?: boolean;
    }

    /**
     * Discover all skills and commands.
     * Convenience function that runs both discoveries in parallel.
     */
    export async function discoverAll(options: DiscoverAllOptions = {}): Promise<DiscoveryResult> {
      const { cwd, includeGlobalSkills = true } = options;

      const [skills, commands] = await Promise.all([
        discoverSkills({
          cwd,
          includeGlobal: includeGlobalSkills,
          includeProject: true
        }),
        discoverCommands({ cwd })
      ]);

      return { skills, commands };
    }
    ```
  </action>
  <verify>
    - `npm run build` compiles without errors
    - All three functions exported: discoverSkills, discoverCommands, discoverAll
  </verify>
  <done>
    Discovery module complete with all exports.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` - compiles without errors
2. Create test script that:
   - Creates test directories with skills and commands
   - Runs discoverAll()
   - Verifies results include both skills and commands with correct locations
3. Test missing directory handling:
   - Run discovery on empty project
   - Should return empty arrays, not throw errors
</verification>

<success_criteria>
- discoverSkills() finds SKILL.md files from ~/.claude/skills/ and ./.claude/skills/
- discoverCommands() finds *.md files from ./.claude/commands/
- Missing directories handled silently (empty results, no errors)
- All discovered files tagged with location ('global' | 'project')
- Symlinks followed during discovery
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>

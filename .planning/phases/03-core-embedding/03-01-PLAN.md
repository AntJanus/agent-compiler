---
phase: 03-core-embedding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/embedding/section-extractor.ts
  - src/types/embedding.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tool detects existing ## SKILLS section boundaries (case-insensitive)"
    - "Tool detects existing ## COMMANDS section boundaries (case-insensitive)"
    - "Tool separates user content from embedded sections without modification"
    - "Section ends at next same-level heading (## to ##) or EOF"
  artifacts:
    - path: "src/types/embedding.ts"
      provides: "SectionBoundary, SplitContent, EmbeddedSection types"
      exports: ["SectionBoundary", "SplitContent", "EmbeddedSection"]
    - path: "src/embedding/section-extractor.ts"
      provides: "Section boundary detection and content splitting"
      exports: ["detectSectionBoundary", "splitContent", "extractUserContent"]
  key_links:
    - from: "src/embedding/section-extractor.ts"
      to: "src/types/embedding.ts"
      via: "import types"
      pattern: "import.*from.*types/embedding"
---

<objective>
Implement section boundary detection and content splitting to extract user content from existing CLAUDE.md files while identifying embedded sections.

Purpose: Enable the merge operation to preserve user content exactly while removing old embedded sections. This is the foundation for idempotent section replacement.

Output: section-extractor.ts with functions for detecting ## SKILLS and ## COMMANDS boundaries, and splitting content into user vs embedded portions.
</objective>

<execution_context>
@/Users/antonin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/antonin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-embedding/03-CONTEXT.md
@.planning/phases/03-core-embedding/03-RESEARCH.md

# Prior phase context (file-safety infrastructure)
@src/file-safety/hash-generator.ts
@src/types/skill.ts
@src/types/command.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create embedding types for section detection</name>
  <files>src/types/embedding.ts, src/types/index.ts</files>
  <action>
Create `src/types/embedding.ts` with types for section operations:

```typescript
/**
 * Boundary information for a detected section
 */
export interface SectionBoundary {
  /** Section type (SKILLS or COMMANDS) */
  sectionName: 'SKILLS' | 'COMMANDS';
  /** Line number where section starts (0-indexed) */
  startLine: number;
  /** Line number where section ends (exclusive, 0-indexed) */
  endLine: number;
  /** Raw content of the section including heading */
  content: string;
}

/**
 * Result of splitting content into user and embedded portions
 */
export interface SplitContent {
  /** User content with embedded sections removed */
  userContent: string;
  /** Hash of user content for validation */
  userContentHash: string;
  /** Detected embedded sections */
  embeddedSections: Map<'SKILLS' | 'COMMANDS', string>;
  /** Whether any embedded sections were found */
  hasEmbeddedSections: boolean;
}

/**
 * Represents a single embedded section to be generated
 */
export interface EmbeddedSection {
  type: 'SKILLS' | 'COMMANDS';
  content: string;
}
```

Update `src/types/index.ts` to export embedding types.
  </action>
  <verify>
`npm run build` succeeds with no type errors.
`grep -r "SectionBoundary\|SplitContent" src/types/` shows exports.
  </verify>
  <done>
Embedding types defined and exported from types module.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement section boundary detection and content splitting</name>
  <files>src/embedding/section-extractor.ts</files>
  <action>
Create `src/embedding/section-extractor.ts` with three functions:

**1. detectSectionBoundary(content: string, sectionName: 'SKILLS' | 'COMMANDS'): SectionBoundary | null**
- Use regex `/^##\s+SKILLS\s*$/im` or `/^##\s+COMMANDS\s*$/im` (case-insensitive, multiline)
- Find section start by matching heading
- Find section end by looking for next `^##\s+` (same-depth heading) OR EOF
- Return null if section not found
- Include heading line in returned content

Key implementation detail from RESEARCH.md:
- Only match same-level headings (##) for section end
- Do NOT end section at ### (subsection headings)
- Case-insensitive detection per user decision

**2. extractUserContent(content: string, embeddedRanges: Array<{start: number, end: number}>): string**
- Takes line ranges of embedded sections
- Returns all lines NOT in embedded ranges
- Preserves user content exactly (no normalization except final trim)

**3. splitContent(content: string): SplitContent**
- Call detectSectionBoundary for both SKILLS and COMMANDS
- Build embeddedRanges from detected boundaries
- Extract user content using extractUserContent
- Generate hash of user content using generateContentHash from file-safety
- Return SplitContent with all fields populated

Import generateContentHash from '../file-safety/hash-generator.js'.

Handle edge cases:
- Empty content -> return empty userContent with empty hash
- No embedded sections -> userContent = full content (trimmed)
- Only SKILLS, no COMMANDS -> extract only SKILLS section
- Only COMMANDS, no SKILLS -> extract only COMMANDS section
- Overlapping sections (## SKILLS contains ## COMMANDS) -> treat as separate based on ## level
  </action>
  <verify>
`npm run build` succeeds.
Create test file manually to verify:
```typescript
import { splitContent } from './src/embedding/section-extractor.js';

const testContent = `# My Project

Some user content here.

## SKILLS

### Skill One
Content for skill one.

## COMMANDS

### Command One
Content for command one.

## Other Section
More user content.
`;

const result = splitContent(testContent);
console.log('User content:', result.userContent);
console.log('Has embedded:', result.hasEmbeddedSections);
console.log('SKILLS found:', result.embeddedSections.has('SKILLS'));
console.log('COMMANDS found:', result.embeddedSections.has('COMMANDS'));
```

Expected: User content includes "# My Project", "Some user content here.", and "## Other Section" but NOT the SKILLS or COMMANDS sections.
  </verify>
  <done>
Section extractor detects ## SKILLS and ## COMMANDS boundaries (case-insensitive), separates user content from embedded sections, and provides hash for validation.
  </done>
</task>

</tasks>

<verification>
1. Type definitions compile without errors
2. Section detection is case-insensitive (matches ## Skills, ## SKILLS, ## skills)
3. Section boundaries respect heading depth (ends at ## not ###)
4. User content preserved exactly (character-for-character minus embedded sections)
5. Hash generated for user content validation
</verification>

<success_criteria>
- `npm run build` passes
- detectSectionBoundary returns correct boundaries for ## SKILLS and ## COMMANDS
- splitContent correctly separates user content from embedded sections
- User content hash is generated for later validation
- Empty/missing sections handled gracefully (return null, not throw)
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-embedding/03-01-SUMMARY.md`
</output>

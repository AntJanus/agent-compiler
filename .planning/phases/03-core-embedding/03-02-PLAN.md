---
phase: 03-core-embedding
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/embedding/section-generator.ts
  - src/embedding/template-generator.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tool generates ## SKILLS section with ### subsections from ParsedSkill array"
    - "Tool generates ## COMMANDS section with ### subsections from ParsedCommand array"
    - "Subsection headings use skill/command name from metadata, not directory name"
    - "Tool creates minimal template file with header comment for new files"
  artifacts:
    - path: "src/embedding/section-generator.ts"
      provides: "Section generation from parsed skills and commands"
      exports: ["generateSkillsSection", "generateCommandsSection"]
    - path: "src/embedding/template-generator.ts"
      provides: "Template generation for new CLAUDE.md files"
      exports: ["generateTemplate", "TEMPLATE_HEADER_COMMENT"]
  key_links:
    - from: "src/embedding/section-generator.ts"
      to: "src/types/skill.ts"
      via: "import ParsedSkill"
      pattern: "import.*ParsedSkill.*from"
    - from: "src/embedding/section-generator.ts"
      to: "src/types/command.ts"
      via: "import ParsedCommand"
      pattern: "import.*ParsedCommand.*from"
---

<objective>
Implement section generation for creating ## SKILLS and ## COMMANDS content from parsed skills/commands, and template generation for new CLAUDE.md files.

Purpose: Provide the content generation side of the merge operation. These generators produce the markdown structure that will be embedded into CLAUDE.md files.

Output: section-generator.ts for creating formatted sections, template-generator.ts for creating new file templates.
</objective>

<execution_context>
@/Users/antonin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/antonin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-embedding/03-CONTEXT.md
@.planning/phases/03-core-embedding/03-RESEARCH.md

# Types from Phase 1
@src/types/skill.ts
@src/types/command.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement section generators for skills and commands</name>
  <files>src/embedding/section-generator.ts</files>
  <action>
Create `src/embedding/section-generator.ts` with two functions:

**1. generateSkillsSection(skills: ParsedSkill[]): string**
- Return empty string if skills array is empty
- Start with `## SKILLS\n\n`
- For each skill:
  - Add `### {skill.metadata.name}\n\n` (use YAML frontmatter name, NOT directory)
  - Add `{skill.content.trim()}\n\n`
- Trim trailing whitespace from final output

**2. generateCommandsSection(commands: ParsedCommand[]): string**
- Return empty string if commands array is empty
- Start with `## COMMANDS\n\n`
- For each command:
  - Add `### {command.name}\n\n`
  - Add `{command.content.trim()}\n\n`
- Trim trailing whitespace from final output

Import types from '../types/index.js':
```typescript
import type { ParsedSkill, ParsedCommand } from '../types/index.js';
```

Structure follows user decision: "Subsections with ### headings using YAML frontmatter names"

Output format example:
```markdown
## SKILLS

### My Skill Name
This is the skill content.
It can span multiple lines.

### Another Skill
More content here.
```
  </action>
  <verify>
`npm run build` succeeds.
Manual test:
```typescript
import { generateSkillsSection } from './src/embedding/section-generator.js';

const skills = [
  {
    path: '/test/skills/my-skill/SKILL.md',
    location: 'global' as const,
    metadata: { name: 'Test Skill', description: 'A test' },
    content: 'Skill instructions here.',
    referencedFiles: []
  }
];

const section = generateSkillsSection(skills);
console.log(section);
// Should output:
// ## SKILLS
//
// ### Test Skill
//
// Skill instructions here.
```
  </verify>
  <done>
Section generators produce properly formatted ## SKILLS and ## COMMANDS markdown with ### subsections using metadata names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement template generator for new files</name>
  <files>src/embedding/template-generator.ts</files>
  <action>
Create `src/embedding/template-generator.ts` with:

**Constant: TEMPLATE_HEADER_COMMENT**
```typescript
export const TEMPLATE_HEADER_COMMENT = `<!-- Generated by Agent Compiler -->
<!-- This file embeds Claude Code skills and commands for reliable agent behavior -->
<!-- User content above the horizontal rule (---) is preserved on re-run -->`;
```

**Function: generateTemplate(options: TemplateOptions): string**

```typescript
interface TemplateOptions {
  includeSkills: boolean;
  includeCommands: boolean;
}
```

Generate template structure (per user decision and CONTEXT.md):
```markdown
<!-- Generated by Agent Compiler -->
<!-- This file embeds Claude Code skills and commands for reliable agent behavior -->
<!-- User content above the horizontal rule (---) is preserved on re-run -->

# CLAUDE

[Add your project-specific instructions here]

---

## SKILLS

## COMMANDS
```

Logic:
- Always include header comment
- Add default `# CLAUDE` heading and placeholder text
- Add horizontal rule separator (`---`)
- Add blank line after separator
- Conditionally add `## SKILLS\n` if includeSkills is true
- Conditionally add `## COMMANDS\n` if includeCommands is true
- If neither includeSkills nor includeCommands, still add separator (future additions)

This template is ONLY used when target file doesn't exist (ENOENT).
For existing files, user content is preserved as-is.
  </action>
  <verify>
`npm run build` succeeds.
Manual test:
```typescript
import { generateTemplate, TEMPLATE_HEADER_COMMENT } from './src/embedding/template-generator.js';

const template = generateTemplate({ includeSkills: true, includeCommands: true });
console.log(template);

// Should include:
// - Header comment
// - # CLAUDE heading
// - Placeholder text
// - ---
// - ## SKILLS
// - ## COMMANDS
```
  </verify>
  <done>
Template generator creates minimal CLAUDE.md template with header comment, placeholder content, separator, and optional section headings.
  </done>
</task>

</tasks>

<verification>
1. Section generators compile without errors
2. Skills section uses metadata.name for ### headings
3. Commands section uses command.name for ### headings
4. Empty arrays return empty string (not section heading alone)
5. Template includes header comment explaining the tool
6. Template structure matches CONTEXT.md specification
</verification>

<success_criteria>
- `npm run build` passes
- generateSkillsSection creates proper ## SKILLS with ### subsections
- generateCommandsSection creates proper ## COMMANDS with ### subsections
- generateTemplate creates file structure matching CONTEXT.md spec
- Empty skill/command arrays produce empty strings
- Content is properly trimmed (no excessive whitespace)
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-embedding/03-02-SUMMARY.md`
</output>

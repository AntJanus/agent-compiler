# Phase 3: Core Embedding - Context

**Gathered:** 2026-02-04
**Status:** Ready for planning

<domain>
## Phase Boundary

Implement the logic that takes parsed skills/commands (from Phase 1) and merges them into existing CLAUDE.md/AGENTS.md files using safe file operations (from Phase 2). The tool manages embedded sections (## SKILLS, ## COMMANDS) while preserving all user content outside those sections. Interactive CLI wizard is Phase 4.

</domain>

<decisions>
## Implementation Decisions

### Section Management Strategy

- Remove and replace sections completely on each run (not in-place updates)
- Sections are independent - can have ## SKILLS without ## COMMANDS or vice versa
- Assume any ## SKILLS or ## COMMANDS sections belong to this tool (replace them)
- Section boundaries determined by Claude's discretion (most robust approach)
- Whitespace handling around removed sections: Claude's discretion
- Section depth matching: Claude's discretion (based on markdown conventions)

### Content Preservation Approach

- Parsing strategy: Claude's discretion (most reliable approach)
- First run creates minimal template file with header comment explaining purpose, then embedded sections
- Validate user sections unchanged after merge using hash check
- Treat all ## SKILLS / ## COMMANDS headings as embedded sections (users shouldn't use these headings for other purposes)

### Merge Behavior and Idempotency

- Second run with different selection: replace with new selection (old embedded content removed)
- Running with same selection: no-op if content identical (skip write)
- No metadata tracking in embedded sections (content is self-documenting)
- Missing skills (deleted from disk): warn but continue (Phase 4 will show warning to user)

### Output Structure and Formatting

- Insert embedded sections at end of file (after user content)
- Separate user content from embedded sections with horizontal rule (`---`) + blank line
- Individual skills/commands within sections separated by ### subsection headings
- Subsection headings use skill name from YAML frontmatter (not directory name)

### Claude's Discretion

- Section boundary detection mechanism (next heading, markers, etc.)
- Whitespace normalization around removed sections
- Section depth matching rules (## only vs any level)
- Parse strategy for separating user content from embedded sections
- Handling of missing skills (warning mechanism)

</decisions>

<specifics>
## Specific Ideas

- File structure when creating new CLAUDE.md:
  ```markdown
  <!-- Generated by Agent Compiler -->
  <!-- This file embeds Claude Code skills and commands for reliable agent behavior -->

  [User can add their content here]

  ---

  ## SKILLS

  ### Skill Name
  [skill content]

  ## COMMANDS

  ### Command Name
  [command content]
  ```

- The tool's contract: "This tool owns ## SKILLS and ## COMMANDS sections. Don't edit them manually."

</specifics>

<deferred>
## Deferred Ideas

- Warning/confirmation UI before replacing existing sections - Phase 4 (CLI)
- Interactive "merge vs replace" choice - Phase 4 (CLI)
- Detailed warning messages for missing skills - Phase 4 (CLI)

</deferred>

---

*Phase: 03-core-embedding*
*Context gathered: 2026-02-04*
